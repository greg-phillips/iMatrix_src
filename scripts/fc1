#!/bin/bash
#
# FC-1 Remote Control Script
# Run from host machine to control FC-1 on target
#
# Usage: ./fc1 [-d destination] [start|stop|restart|status|enable|disable|run|log|cmd|deploy|push|ssh]
#

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TARGET_HOST="192.168.7.1"
TARGET_PORT="22222"
TARGET_USER="root"
TARGET_PASS="PasswordQConnect"

# Parse optional -d argument
if [ "$1" = "-d" ] && [ -n "$2" ]; then
    TARGET_HOST="$2"
    shift 2
fi

# Remote script location
REMOTE_SCRIPT="/tmp/fc1_service.sh"
LOCAL_SCRIPT="${SCRIPT_DIR}/fc1_service.sh"

# Binary paths
LOCAL_BINARY="${SCRIPT_DIR}/../Fleet-Connect-1/build/FC-1"
REMOTE_BINARY="/usr/qk/bin/FC-1"

# Expect tools paths
# Deploy to /usr/qk/etc/sv/FC-1/expect/ which is persistent across reboots
# (unlike /usr/local which may be volatile on embedded systems)
EXPECT_PACKAGE="${SCRIPT_DIR}/../external_tools/build/expect-arm.tar.gz"
EXPECT_CMD_SCRIPT="${SCRIPT_DIR}/fc1_cmd.exp"
REMOTE_EXPECT_DIR="/usr/qk/etc/sv/FC-1/expect"
REMOTE_EXPECT_CMD="/tmp/fc1_cmd.exp"

# SSH command with options (using arrays to avoid eval issues with special chars)
SSH_OPTS=(-p "${TARGET_PORT}" -o StrictHostKeyChecking=no -o ConnectTimeout=10)
SCP_OPTS=(-P "${TARGET_PORT}" -o StrictHostKeyChecking=no)
# Legacy string versions for backwards compatibility with existing code
SSH_CMD="sshpass -p '${TARGET_PASS}' ssh -p ${TARGET_PORT} -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${TARGET_USER}@${TARGET_HOST}"
SCP_CMD="sshpass -p '${TARGET_PASS}' scp -P ${TARGET_PORT} -o StrictHostKeyChecking=no"

# Check if sshpass is installed
check_sshpass() {
    if ! command -v sshpass &> /dev/null; then
        echo "Error: sshpass not installed"
        echo "Install with: sudo apt-get install sshpass"
        exit 1
    fi
}

# Clear SSH known_hosts entry for target (handles host key changes)
clear_host_key() {
    echo "Clearing old SSH host key for [${TARGET_HOST}]:${TARGET_PORT}..."
    ssh-keygen -f "$HOME/.ssh/known_hosts" -R "[${TARGET_HOST}]:${TARGET_PORT}" 2>/dev/null
}

# Check if target is reachable and SSH works
check_target() {
    if ! ping -c 1 -W 2 "$TARGET_HOST" &> /dev/null; then
        echo "Error: Cannot reach target at $TARGET_HOST"
        exit 1
    fi

    # Test SSH connection and check for host key issues
    SSH_TEST=$(eval $SSH_CMD "echo ok" 2>&1)
    if echo "$SSH_TEST" | grep -q "REMOTE HOST IDENTIFICATION HAS CHANGED"; then
        echo "Device changed detected - host key mismatch"
        clear_host_key
        echo "Retrying connection..."
        SSH_TEST=$(eval $SSH_CMD "echo ok" 2>&1)
    fi

    # Check if it's a host key verification issue
    if echo "$SSH_TEST" | grep -q "Host key verification failed"; then
        clear_host_key
        echo "Retrying connection..."
        SSH_TEST=$(eval $SSH_CMD "echo ok" 2>&1)
    fi

    # Success if output contains "ok" (may also have banner/warnings)
    if ! echo "$SSH_TEST" | grep -q "^ok$"; then
        echo "Error: SSH connection failed"
        echo "$SSH_TEST"
        exit 1
    fi
}

# Deploy script to target
deploy_script() {
    echo "Deploying fc1_service.sh to target..."
    eval $SCP_CMD "$LOCAL_SCRIPT" "${TARGET_USER}@${TARGET_HOST}:${REMOTE_SCRIPT}"
    eval $SSH_CMD "chmod +x ${REMOTE_SCRIPT}"
    echo "Deployed to ${REMOTE_SCRIPT}"
}

# Push built binary to target
# Usage: push_binary [-run]
push_binary() {
    local start_service=false
    if [ "$1" = "-run" ]; then
        start_service=true
    fi

    if [ ! -f "$LOCAL_BINARY" ]; then
        echo "Error: Binary not found at $LOCAL_BINARY"
        echo "Run 'make' in Fleet-Connect-1/build first"
        exit 1
    fi

    echo "Stopping FC-1 service..."
    run_remote "sv stop FC-1" 2>/dev/null || true
    sleep 1

    echo "Pushing FC-1 binary to target..."
    eval $SCP_CMD "$LOCAL_BINARY" "${TARGET_USER}@${TARGET_HOST}:${REMOTE_BINARY}"

    echo "Setting permissions..."
    run_remote "chmod +x ${REMOTE_BINARY}"

    if [ "$start_service" = true ]; then
        echo "Starting FC-1 service..."
        run_remote "sv start FC-1"
    else
        echo "FC-1 service left stopped (use 'push -run' to auto-start)"
    fi

    echo ""
    echo "Deployed: $LOCAL_BINARY -> $REMOTE_BINARY"
    run_remote "ls -la ${REMOTE_BINARY}"
}

# Run command on target (uses eval - avoid for commands with special chars)
run_remote() {
    eval $SSH_CMD "$@"
}

# Run command on target safely without eval (preserves special characters like ?)
run_ssh() {
    sshpass -p "${TARGET_PASS}" ssh "${SSH_OPTS[@]}" "${TARGET_USER}@${TARGET_HOST}" "$@"
}

# Run service script on target
run_service_cmd() {
    # Deploy if script doesn't exist on target
    run_remote "test -f ${REMOTE_SCRIPT}" 2>/dev/null || deploy_script
    # Use sh to run script (target /tmp may be noexec)
    run_remote "sh ${REMOTE_SCRIPT} $*"
}

# Deploy expect tools to target
deploy_expect() {
    if [ ! -f "$EXPECT_PACKAGE" ]; then
        echo "Error: Expect package not found at $EXPECT_PACKAGE"
        echo "Run the build_expect.sh script first"
        exit 1
    fi

    echo "Deploying expect tools to target (persistent location)..."
    echo "Package: $EXPECT_PACKAGE"
    echo "Target: ${REMOTE_EXPECT_DIR}"

    # Copy expect package to target with verification
    echo "Copying package to target..."
    if ! eval $SCP_CMD "$EXPECT_PACKAGE" "${TARGET_USER}@${TARGET_HOST}:/tmp/expect-arm.tar.gz"; then
        echo "Error: SCP failed to copy expect package"
        exit 1
    fi

    # Verify the file arrived
    if ! run_remote "test -f /tmp/expect-arm.tar.gz"; then
        echo "Error: Package file not found on target after SCP"
        exit 1
    fi

    # Create directory and extract
    echo "Extracting to ${REMOTE_EXPECT_DIR}..."
    run_remote "mkdir -p ${REMOTE_EXPECT_DIR}"

    if ! run_remote "cd ${REMOTE_EXPECT_DIR} && tar xzf /tmp/expect-arm.tar.gz"; then
        echo "Error: Failed to extract expect package"
        run_remote "rm -f /tmp/expect-arm.tar.gz"
        exit 1
    fi

    # Clean up temp file
    run_remote "rm -f /tmp/expect-arm.tar.gz"

    # Verify deployment
    if run_remote "test -x ${REMOTE_EXPECT_DIR}/bin/expect-wrapper"; then
        echo "Expect tools deployed successfully to ${REMOTE_EXPECT_DIR}"
    else
        echo "Error: expect-wrapper not found after deployment"
        exit 1
    fi
}

# Check if expect is installed on target
check_expect_installed() {
    run_remote "test -x ${REMOTE_EXPECT_DIR}/bin/expect" 2>/dev/null
}

# Execute CLI command via expect/microcom
run_cli_cmd() {
    local cli_cmd="$1"

    if [ -z "$cli_cmd" ]; then
        echo "Error: No command specified"
        echo "Usage: $0 cmd \"<command>\""
        exit 1
    fi

    # Check if expect is installed, deploy if not
    if ! check_expect_installed; then
        echo "Expect not found on target. Deploying..."
        deploy_expect
    fi

    # Copy expect script to target
    if [ ! -f "$EXPECT_CMD_SCRIPT" ]; then
        echo "Error: Expect script not found at $EXPECT_CMD_SCRIPT"
        exit 1
    fi

    eval $SCP_CMD "$EXPECT_CMD_SCRIPT" "${TARGET_USER}@${TARGET_HOST}:${REMOTE_EXPECT_CMD}"
    run_remote "chmod +x ${REMOTE_EXPECT_CMD}"

    # Run the expect script with the command
    # Quote the command argument for remote shell to prevent glob expansion
    echo "Executing: $cli_cmd"
    echo "---"
    run_ssh "${REMOTE_EXPECT_DIR}/bin/expect-wrapper ${REMOTE_EXPECT_CMD} '${cli_cmd}'"
}

show_help() {
    echo "FC-1 Remote Control"
    echo ""
    echo "Usage: $0 [-d destination] <command> [options]"
    echo ""
    echo "Options:"
    echo "  -d <addr>   Specify target host (default: 192.168.7.1)"
    echo ""
    echo "Commands:"
    echo "  start       Start FC-1 service on target"
    echo "  stop        Stop FC-1 service on target"
    echo "  restart     Restart FC-1 service"
    echo "  status      Show service status"
    echo "  enable      Enable FC-1 auto-start and start service"
    echo "  disable     Disable FC-1 auto-start (with confirmation)"
    echo "  disable -y  Disable without confirmation prompt"
    echo "  run [opts]  Run FC-1 in foreground on target"
    echo "  log         Show recent logs"
    echo "  ppp         Show PPP link status (interface, service, log)"
    echo "  cmd <cmd>   Execute CLI command via microcom (returns output)"
    echo "  deploy      Deploy service script to target"
    echo "  push        Push built FC-1 binary to target (leaves service stopped)"
    echo "  push -run   Push binary and start FC-1 service"
    echo "  ssh         Open SSH session to target"
    echo "  clear-key   Clear SSH host key (for device changes)"
    echo "  help        Show this help"
    echo ""
    echo "Target: ${TARGET_USER}@${TARGET_HOST}:${TARGET_PORT}"
    echo ""
    echo "Examples:"
    echo "  $0 start                 # Start FC-1 on default host"
    echo "  $0 -d 192.168.1.100 start  # Start FC-1 on specific host"
    echo "  $0 stop                  # Stop FC-1"
    echo "  $0 enable                # Enable auto-start"
    echo "  $0 disable               # Disable auto-start (prompts)"
    echo "  $0 disable -y            # Disable without prompt"
    echo "  $0 status                # Check status"
    echo "  $0 -d 10.0.0.50 status   # Check status on specific host"
    echo "  $0 run -S                # Run with config summary"
    echo "  $0 ppp                   # Show PPP link status"
    echo "  $0 cmd \"help\"            # Execute 'help' CLI command"
    echo "  $0 cmd \"cell status\"     # Execute 'cell status' CLI command"
    echo "  $0 cmd \"imx stats\"       # Execute 'imx stats' CLI command"
    echo "  $0 deploy                # Update service script on target"
    echo "  $0 push                  # Deploy binary (service stays stopped)"
    echo "  $0 push -run             # Deploy binary and start service"
    echo "  $0 -d beaglebone.local ssh  # SSH to specific host"
    echo ""
}

# Main
check_sshpass

case "$1" in
    start|stop|restart|status|enable|log|create-run|ppp)
        check_target
        run_service_cmd "$1"
        ;;
    disable)
        check_target
        shift
        run_service_cmd "disable" "$@"
        ;;
    run)
        check_target
        shift
        run_service_cmd "run" "$@"
        ;;
    deploy)
        check_target
        deploy_script
        ;;
    push)
        check_target
        shift
        push_binary "$@"
        ;;
    ssh)
        check_target
        echo "Connecting to ${TARGET_HOST}..."
        eval $SSH_CMD
        ;;
    cmd)
        check_target
        shift
        run_cli_cmd "$*"
        ;;
    clear-key)
        clear_host_key
        echo "Host key cleared. Next connection will accept new key."
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -z "$1" ]; then
            # Default: show status
            check_target
            run_service_cmd "status"
        else
            echo "Unknown command: $1"
            echo "Run '$0 help' for usage."
            exit 1
        fi
        ;;
esac

exit 0
